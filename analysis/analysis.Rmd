---
title: "analysis"
author: "Calli Quire"
date: "2025-02-14"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Set up
## Download, install, run relevant packages
```{r, warning=FALSE, message=FALSE, echo=FALSE}
# Install relevant packages
install.packages("dplyr")
install.packages("survey")
install.packages("haven")
install.packages("tidyr")
install.packages("ggplot2")
install.packages("ggbeeswarm")
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
#Load relevant packages
#+ message = FALSE, warning=FALSE
library(dplyr)
library(survey)
library(haven)
library(workflowr)
library(tidyr)
library(ggplot2)
library(ggbeeswarm)
#'
options(survey.lonely.psu='adjust')

# Display Version Information
cat("R package versions:\n")
for (p in c("base", "survey","dplyr"))
{ cat(p, ": ", as.character(packageVersion(p)), "\n")}
```


# Import data
## Download and read data
### 1. Demographic data
```{r}
## Demographic (DEMO) data
## isolate participant identification/sequence number, gender, age, variances

# 1999-2000
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/1999/DataFiles/DEMO.XPT", tf <- tempfile(), mode="wb")
DEMO <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2001-2002
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2001/DataFiles/DEMO_B.XPT", tf <- tempfile(), mode="wb")
DEMO_B <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2003-2004
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2003/DataFiles/DEMO_C.XPT", tf <- tempfile(), mode="wb")
DEMO_C <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2005-2006
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2005/DataFiles/DEMO_D.XPT", tf <- tempfile(), mode="wb")
DEMO_D <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2007-2008
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2007/DataFiles/DEMO_E.XPT", tf <- tempfile(), mode="wb")
DEMO_E <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2009-2010
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2009/DataFiles/DEMO_F.xpt", tf <- tempfile(), mode="wb")
DEMO_F <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2011-2012
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2011/DataFiles/DEMO_G.XPT", tf <- tempfile(), mode="wb")
DEMO_G <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2013-2014
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/DEMO_H.XPT", tf <- tempfile(), mode="wb")
DEMO_H <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2015-2016
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/DEMO_I.XPT", tf <- tempfile(), mode="wb")
DEMO_I <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# 2017-2018
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2017/DataFiles/DEMO_J.XPT", tf <- tempfile(), mode="wb")
DEMO_J <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

```


### 2. Reproductive health question (RHQ) data
```{r}
# Reproductive Health Questions (RHQ)
# isolate sequence number, age at first live birth, has had regular periods in the last 12 mo, reason for not having regular periods in last 12 mo

# 1999-2000
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/1999/DataFiles/RHQ.XPT", tf <- tempfile(), mode="wb")
RHQ <- foreign::read.xport(tf)[,c("SEQN","RHQ180", "RHQ030", "RHQ040")]

# 2001-2002
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2001/DataFiles/RHQ_B.XPT", tf <- tempfile(), mode="wb")
RHQ_B <- foreign::read.xport(tf)[,c("SEQN","RHQ180", "RHQ030", "RHQ040")]

# 2003-2004
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2003/DataFiles/RHQ_C.XPT", tf <- tempfile(), mode="wb")
RHQ_C <- foreign::read.xport(tf)[,c("SEQN","RHQ180", "RHQ031", "RHD042")]

# 2005-2006
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2005/DataFiles/RHQ_D.XPT", tf <- tempfile(), mode="wb")
RHQ_D <- foreign::read.xport(tf)[,c("SEQN","RHQ180", "RHQ031", "RHD042")]

# 2007-2008
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2007/DataFiles/RHQ_E.XPT", tf <- tempfile(), mode="wb")
RHQ_E <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD042")]

# 2009-2010
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2009/DataFiles/RHQ_F.xpt", tf <- tempfile(), mode="wb")
RHQ_F <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD042")]

# 2011-2012
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2011/DataFiles/RHQ_G.xpt", tf <- tempfile(), mode="wb")
RHQ_G <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD042")]

# 2013-2014
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/RHQ_H.xpt", tf <- tempfile(), mode="wb")
RHQ_H <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD043")]

# 2015-2016
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/RHQ_I.xpt", tf <- tempfile(), mode="wb")
RHQ_I <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD043")]

# 2017-2018
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2017/DataFiles/RHQ_J.xpt", tf <- tempfile(), mode="wb")
RHQ_J <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD043")]

```


### 3. Bone mineral denisty (BMD) data
```{r}
# Dual-Energy X-Ray Absorptiometry - Whole Body, focusing in Lumbar Spine BMD (DXX)
# isolate sequence number, lumbar spine BMD

# 1999-2000
download.file("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx.xpt", tf <- tempfile(), mode="wb")
DXX <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2001-2002
download.file("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_B.xpt", tf <- tempfile(), mode="wb")
DXX_B <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2003-2004
download.file("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_c.xpt", tf <- tempfile(), mode="wb")
DXX_C <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2005-2006
download.file("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_d.xpt", tf <- tempfile(), mode="wb")
DXX_D <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2011-2012
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2011/DataFiles/DXX_G.xpt", tf <- tempfile(), mode="wb")
DXX_G <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2013-2014
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/DXX_H.xpt", tf <- tempfile(), mode="wb")
DXX_H <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2015-2016
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/DXX_I.xpt", tf <- tempfile(), mode="wb")
DXX_I <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]

# 2017-2018
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2017/DataFiles/DXX_J.xpt", tf <- tempfile(), mode="wb")
DXX_J <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]


# Dual-Energy X-Ray Absorptiometry - Total Spine (DXXSPN)
# isolated sequence number, total spine BMD
# had to use total spine BMD for 2007-2008 and 2009-2010 data sets b/c lumber spine BMD not collected for those years

# 2007-2008
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2007/DataFiles/DXXSPN_E.xpt", tf <- tempfile(), mode="wb")
DXX_E <- foreign::read.xport(tf)[,c("SEQN", "DXXOSBMD")]

# 2009-2010
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2009/DataFiles/DXXSPN_F.xpt", tf <- tempfile(), mode="wb")
DXX_F <- foreign::read.xport(tf)[,c("SEQN", "DXXOSBMD")]

```

# Clean
## Combine the data sets
```{r}
# combine data sets for DEMO, RHQ, and DXX into three sub-sets
DEMO <- bind_rows(DEMO, DEMO_B, DEMO_C, DEMO_D, DEMO_E, DEMO_F, DEMO_G, DEMO_H, DEMO_I, DEMO_J)
RHQ <- bind_rows(RHQ, RHQ_B, RHQ_C, RHQ_D, RHQ_E, RHQ_F, RHQ_G, RHQ_H, RHQ_I, RHQ_J) 
DXX <- bind_rows(DXX, DXX_B, DXX_C, DXX_D, DXX_E, DXX_F, DXX_G, DXX_H, DXX_I, DXX_J)
```

## Merge subsets into one main data set
```{r}
# merge DEMO + RHQ
predata <- left_join(DEMO, RHQ, by = "SEQN") 

# merge 'predata' = DEMO, RHQ + DXX
data <- left_join(predata, DXX, by = "SEQN")
```

## Omit males from data
```{r}
# remove male study participants from analysis data; responses to RIAGENDR coded 1
data <- subset(data, !(RIAGENDR %in% c(1)))
```

## Combine any single variables with 2+ codes into single columns 
```{r}
# want to combine any variables that have two different variable names (e.g., RHD180 = RHQ180) into single columns

# combining RHD180 and RHQ180
data$RHX180 <- coalesce(data$RHD180, data$RHQ180)

# combining DXXLSBMD and DXXOSBMD
data$DXXBMD <- coalesce(data$DXXLSBMD, data$DXXOSBMD)
```

## Remove any participants without BMD data
```{r}
data <- drop_na(data, "DXXBMD")
```

## Remove any participants without Age at First Live Birth (RHX180) data
```{r}
data <- drop_na(data, "RHX180")
```



