---
title: "nhanes_exclusion_cleaning"
author: "cquire"
date: "2025-01-26"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

### Introduction


### Downloading and Importing Datafiles
```{r}
# Install relevant packages
install.packages("dplyr")
install.packages("survey")
install.packages("haven")
install.packages("tidyr")
```

```{r}
#Load relevant packages
#+ message = FALSE, warning=FALSE
library(dplyr)
library(survey)
library(haven)
library(workflowr)
library(tidyr)
#'
options(survey.lonely.psu='adjust')

# Display Version Information
cat("R package versions:\n")
for (p in c("base", "survey","dplyr"))
{ cat(p, ": ", as.character(packageVersion(p)), "\n")}
```

```{r}
# Download and read data

# Demographic (DEMO)
# isolated participant identification/sequence number, gender, age, variances
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/DEMO_H.XPT", tf <- tempfile(), mode="wb")
DEMO_H <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/DEMO_I.xpt", tf <- tempfile(), mode="wb")
DEMO_I <- foreign::read.xport(tf)[,c("SEQN","RIAGENDR","RIDAGEYR","SDMVSTRA","SDMVPSU","WTMEC2YR")]

# Reproductive Health Questions (RHQ)
# isolated sequence number, age at first live birth, has had regular periods in the last 12 mo, reason for not having regular periods in last 12 mo
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/RHQ_H.XPT", tf <- tempfile(), mode="wb")
RHQ_H <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD043")]
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/RHQ_I.xpt", tf <- tempfile(), mode="wb")
RHQ_I <- foreign::read.xport(tf)[,c("SEQN","RHD180", "RHQ031", "RHD043")]

# Dual-Energy X-ray Absorptiometry - Whole Body (DXX)
# isolated sequence number, lumbar spine BMD
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2013/DataFiles/DXX_H.xpt", tf <- tempfile(), mode="wb")
DXX_H <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]
download.file("https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2015/DataFiles/DXX_I.xpt", tf <- tempfile(), mode="wb")
DXX_I <- foreign::read.xport(tf)[,c("SEQN", "DXXLSBMD")]
```

### Data Cleaning
```{r}
# combining H, I dataset
DEMO <- bind_rows(DEMO_H, DEMO_I)
RHQ <- bind_rows(RHQ_H, RHQ_I)
DXX <- bind_rows(DXX_H, DXX_I)
```

# Merge DEMO, RHQ, DXX datasets
```{r}
# merging DEMO and RHQ
medium_data <- left_join(DEMO, RHQ, by = "SEQN")

# merging medium_data (includes DEMO, RHQ) w/ DXX
mega_data <- left_join(medium_data, DXX, by = "SEQN")
```

# Omit missing (N/A) AFB RHQ values
```{r}
# removing missing AFB values from dataset; will subsequently remove all males from set
fem_mega_data <- drop_na(mega_data, "RHD180")
```

# Remove menopausal and postmenopausal participants
*** want to omit participants who are menopausal or postmenopausal; can do so by omitting those who are:
(1) not having a menstrual period in past 12mo and not b/c they were pregnant, breastfeeding, or had a hysterectomy, and
  (1A) if had hysterectomy, are they below the avg age of menopause onset 49 yo

```{r}
# omit missing (N/A) values from RHQ031
fem_mega_data_1 <- drop_na(fem_mega_data, "RHQ031")

# omit participants who answer menopause (7), other (9), refused (77), don't know (99) to RHD043
# this removes participants who aren't having periods b/c of menopause, another reason, or refused/don't know
fem_mega_data_2 <- subset(fem_mega_data_1, !(RHD043 %in% c(7, 9, 77, 99)))

# omit participants who answer >/= 49 to RIDAGEYR
# this removes participants who may have had a hysterectomy, and therefore cannot say if they are experiencing menopause (based on lack of menstruation), and are at or above the average age that menopause occurs  
fert_fem_mega_data <- subset(fem_mega_data_2, !(RIDAGEYR %in% c(49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80)))
```




